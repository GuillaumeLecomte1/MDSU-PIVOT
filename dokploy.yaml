app: pivot
repository: https://github.com/GuillaumeLecomte1/MDSU-PIVOT
branch: miseEnProd
domain: pivot.guillaume-lcte.fr
port: 4004

build:
  steps:
    - name: Installation des dépendances PHP
      command: composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev
    
    - name: Installation des dépendances Node.js
      command: npm ci
    
    - name: Compilation des assets
      command: npm run build
    
    - name: Configuration Laravel
      command: |
        cp .env.example .env
        php artisan key:generate
        php artisan config:cache
        php artisan route:cache
        php artisan view:cache

deploy:
  services:
    - name: web
      image: php:8.1-fpm
      port: 4004
      volumes:
        - ./:/var/www/html
      environment:
        - APP_ENV=production
        - APP_URL=https://pivot.guillaume-lcte.fr
        - DB_CONNECTION=mysql
        - DB_HOST=${DB_HOST}
        - DB_PORT=${DB_PORT}
        - DB_DATABASE=${DB_DATABASE}
        - DB_USERNAME=${DB_USERNAME}
        - DB_PASSWORD=${DB_PASSWORD}

  hooks:
    post-deploy:
      - php artisan migrate --force 